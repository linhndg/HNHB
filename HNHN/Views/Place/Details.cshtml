@model HNHB.Models.Entities.Place

@{
    ViewBag.Title = Model.Name;
    Layout = "~/Views/Shared/_Layout.cshtml";
    string rateScript = "";
}
<link href="~/Content/dropzone/css/dropzone.css" rel="stylesheet" />
<link href="~/Content/jquery-ui/jquery-ui-themes-1.11.2/themes/flick/jquery-ui.min.css" rel="stylesheet" />
<link href="~/Content/ResponsiveImageGallery/css/elastislide.css" rel="stylesheet" />
<link href="~/Content/ResponsiveImageGallery/css/style.css" rel="stylesheet" />
<link href="~/Content/themes/ace/css/dataTables.bootstrap.css" rel="stylesheet" />

<script src="~/Content/themes/ace/js/dataTables/jquery.dataTables.min.js"></script>
<script src="~/Content/themes/ace/js/dataTables/jquery.dataTables.bootstrap.min.js"></script>
<style>
    .main-pic-thumb {
        display: inline-block;
        width: 100%;
        height: 368px;
        border-radius: 3px;
        background-position: center center;
        background-size: cover;
    }

    #imageModal .modal-content {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }

    .dropzone {
        min-height: 250px;
        padding-top: 5px;
    }

        .dropzone .dz-default.dz-message {
            display: none;
        }

    .dropzone-previews .dz-preview {
        margin: 11px;
    }

    .dz-progress, .dz-remove {
        width: 100px;
    }

    #previews {
        min-height: 190px;
        border: 2px dashed #CCC;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 15px;
        margin-left: 15px;
        color: #CCC;
    }

        #previews h4 {
            color: #CCC;
            text-align: center;
            line-height: 190px;
        }

    ol, ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }

    .es-carousel ul {
        display: block;
    }

    .es-carousel-wrapper {
        border-radius: 8px;
        box-shadow: none;
        margin-bottom: 0;
    }

    .es-carousel {
        background-color: transparent;
    }

        .es-carousel ul li a {
            border-style: none;
            opacity: 1;
        }

            .es-carousel ul li a img {
                border-radius: 8px;
            }

    .rg-image img {
        max-height: 430px;
    }

    #rg-gallery .es-carousel-wrapper {
        border-radius: 0 0 10px 10px;
        box-shadow: none;
        margin-bottom: 0;
    }

    #main-carousel .es-carousel ul li a {
        display: block;
        border-style: solid;
        border-color: #222;
        opacity: 0.8;
        border-radius: 8px;
        -webkit-touch-callout: none;
        /* option */
        -webkit-transition: all 0.2s ease-in-out;
        -moz-transition: all 0.2s ease-in-out;
        -o-transition: all 0.2s ease-in-out;
        -ms-transition: all 0.2s ease-in-out;
        transition: all 0.2s ease-in-out;
    }

    #main-carousel .es-carousel ul li.selected a {
        border-color: #FFF;
        opacity: 1;
    }

    .rg-image-wrapper {
        border-radius: 10px 10px 0px 0px;
    }

    .rg-image-nav a {
        border-radius: 10px 0px 0px 0px;
    }

        .rg-image-nav a.rg-image-nav-next {
            border-radius: 0px 10px 0px 0px;
        }

    #place-basic-info div {
        display: inline;
        float: left;
        margin: -2px 0px -6px 0px;
    }

        #place-basic-info div span {
            color: #32C8DE;
            font-size: 20px;
            font-weight: 700;
        }

        #place-basic-info div p {
            color: #666;
            font-size: 11px;
            font-weight: normal;
            margin-top: -5px;
        }


    #totalRateInfo {
        width: 70%;
    }

        #totalRateInfo div {
            width: 20%;
            display: inline;
            float: left;
        }

    .pac-container {
        z-index: 1050;
    }
</style>
<div class="container">
    <div class="row" style="margin-top:0.5%">
        <div class="col-md-3">
            <div class="main-pic-thumb" style="background-image: url('@Url.Content(Model.Images.First().ImagePath)');"></div>
        </div>
        <div class="col-md-7">
            <h3>
                @Html.DisplayFor(m => m.Name)
                @if (Model.IsApproved)
                {
                    <i class="fa fa-check-circle lblue"></i>
                }
            </h3>
            <div>
                <a href="@Url.Action("Index", "Place", new { subcategory = Model.SubCategoryId })">@Html.DisplayFor(m => m.SubCategory.Name)</a>
                @if (Model.AppliedTagPlaces.Count > 0)
                {
                    <text> - </text>
                    foreach (var tag in Model.AppliedTagPlaces)
                    {
                        <a class="label label-sm label-lblue" href="@Url.Action("Index", "Place", new { tag = tag.TagId })">@tag.Tag.Name</a>
                    }
                }
                @if (Model.Virtualtourist != null && Model.Virtualtourist != "")
                {
                    if (!(Model.AppliedTagPlaces.Count > 0))
                    {
                        <text> - </text>
                    }
                    <a class="label label-sm label-red" href="@Url.Action("Virtualtourist", "Place", new { id = Model.Id })">360 View</a>
                }
            </div>
            <hr />
            <div class="row">
                <div id="place-basic-info" class="col-md-12">
                    <div id="totalRateInfo"></div>
                    <div style="width:15%">
                        <div>
                            <span>@Html.DisplayFor(m => m.View)</span>
                            <p>Lượt xem</p>
                        </div>
                    </div>
                    <div id="placeReviewCount" style="width:15%"></div>
                </div>
            </div>
            <hr />
            <div>
                <p><i class="fa fa-map-marker"></i> @Html.DisplayFor(m => m.Address) (<a href="#" data-toggle="modal" data-target="#mapModal" onclick="initializeMap()">Xem bản đồ</a>)</p>
                <p><i class="fa fa-phone"></i> @Html.DisplayFor(m => m.PhoneNumber)</p>
                @if ((Model.StartTime == null || Model.StartTime == "") && (Model.EndTime == null || Model.EndTime == ""))
                {
                    <p><i class="fa fa-clock-o"></i> Đang cập nhật</p>
                }
                else if (Model.StartTime == null || Model.StartTime == "")
                {
                    <p><i class="fa fa-clock-o"></i> Đóng cửa lúc @Html.DisplayFor(m => m.EndTime)</p>
                }
                else if (Model.EndTime == null || Model.EndTime == "")
                {
                    <p><i class="fa fa-clock-o"></i> Mở cửa lúc @Html.DisplayFor(m => m.StartTime)</p>
                }
                else
                {
                    <p>
                        <i class="fa fa-clock-o"></i>
                        @{
                    var now = DateTime.Now;
                    if (Convert.ToDateTime(Model.StartTime.ToString()) <= now && Convert.ToDateTime(Model.EndTime.ToString()) >= now)
                    {
                        <strong class="green">Đang mở cửa</strong>
                    }
                    else
                    {
                        <strong class="red">Chưa mở cửa</strong>
                    }
                        }
                        @Html.DisplayFor(m => m.StartTime) - @Html.DisplayFor(m => m.EndTime)
                    </p>
                }
                @if (Model.Items.Count > 0)
                {
                    <p>
                        <i class="fa fa-usd"></i> Giá từ @Model.Items.OrderBy(i => i.Price).First().Price.ToString("N0") VND
                        (<a href="#" data-toggle="modal" data-target="#itemModal">Xem chi tiết</a>)
                    </p>
                }
                else
                {
                    <p><i class="fa fa-usd"></i> Đang cập nhật</p>
                }
            </div>
            <div>
                <!-- Elastislide Carousel Thumbnail Viewer -->
                <div class="es-carousel-wrapper" id="place-carousel">
                    <div class="es-nav">
                        <span class="es-nav-prev">Previous</span>
                        <span class="es-nav-next">Next</span>
                    </div>
                    <div class="es-carousel">
                        <ul>
                            @foreach (var image in Model.Images)
                            {
                                <li>
                                    <a href="#">
                                        <img src="@Url.Content(image.ImageSmallPath)" alt="@Html.Raw("image" + image.Id)" onclick="@Html.Raw("showImage(" + image.Id + "," + image.PlaceId + ",0)")" />
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                </div><!-- End Elastislide Carousel Thumbnail Viewer -->
            </div>
        </div>
        <div class="col-md-2">
            <div class="row">
                @if (User.Identity.IsAuthenticated)
                {
                    <div class="brand-bg br-lblue">
                        <a href="#" data-toggle="modal" data-target="#reviewModal" class="twitter">
                            <i class="fa fa-comment square-4"></i> Đánh giá
                        </a>
                    </div>
                }
                else
                {
                    <div class="brand-bg br-lblue">
                        <a onclick="doLogin()" class="twitter" style="cursor:pointer">
                            <i class="fa fa-comment square-4"></i> Đánh giá
                        </a>
                    </div>
                }
                <div class="brand-bg br-blue" style="margin-top:5px;">
                    <a href="#" class="facebook" style="color:#609CEC;">
                        <i class="fa fa-share-alt square-4"></i> Chia sẻ
                    </a>
                </div>
                @if (User.Identity.IsAuthenticated)
                {
                    <div class="brand-bg br-red" style="margin-top:5px;">
                        <a href="#" class="google-plus" style="color:#ED5441;" data-toggle="modal" data-target="#reportModal">
                            <i class="fa fa-remove square-4"></i> Báo lỗi
                        </a>
                    </div>
                }
                else
                {
                    <div class="brand-bg br-red" style="margin-top:5px;">
                        <a onclick="doLogin()" class="google-plus" style="color:#ED5441;cursor:pointer;" data-toggle="modal" data-target="#reportModal">
                            <i class="fa fa-remove square-4"></i> Báo lỗi
                        </a>
                    </div>
                }
                @if (ViewBag.Edidable != null && ViewBag.Edidable)
                {
                    <div class="brand-bg br-orange" style="margin-top:5px;">
                        <a href="/Place/EditPlaceInfo/@Model.Id" class="bitcoin" style="color:#F8A841;">
                            <i class="fa fa-pencil square-4"></i> Chỉnh sửa
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
    <!-- Modal code -->
    <div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="mapModalLabel">Bản đồ - @Html.DisplayFor(m => m.Name)</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8" id="map-contain">
                            <div id="map-canvas" style="height: 400px; width:100%;"></div>
                        </div>
                        <div class="col-md-4" style="max-height:400px">
                            <!-- Accordion starts -->
                            <div class="panel-group accordion-alt3" id="accordion-alt3">
                                <!-- Panel. Use "panel-XXX" class for different colors. Replace "XXX" with color. -->
                                <div class="panel">
                                    <!-- Panel heading -->
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion-alt3" href="#collapseOne-alt3">
                                                <b>Tìm đường đi</b>
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="collapseOne-alt3" class="panel-collapse collapse in">
                                        <!-- Panel body -->
                                        <div class="panel-body">
                                            <input id="startvalue" type="text" class="form-control" placeholder="Điểm xuất phát" onchange="ChangeLocation()" />
                                            <div class="checkbox">
                                                <div style="line-height: 22px !important">
                                                    <label>
                                                        <input type="checkbox" id="chkCurrLocation" onclick="getLocation()" /> Dùng địa điểm hiện tại
                                                    </label>
                                                </div>
                                            </div>
                                            <input type="button" value="Tìm đường" onclick="return calcRoute()" class="btn btn-color btn-sm" style="width:100%" />
                                        </div>
                                    </div>
                                </div>
                                <div class="panel" id="route-panel" style="display:none;">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion-alt3" href="#collapseTwo-alt3">
                                                <b>Chỉ dẫn</b>
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="collapseTwo-alt3" class="panel-collapse collapse">
                                        <div class="panel-body" style="max-height:315px;overflow-y:scroll;">
                                            <div id="directions-panel"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Accordion ends -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    <!-- Modal code -->
    <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div>
                                <script id="img-wrapper-tmpl" type="text/x-jquery-tmpl">
                                    <div class="rg-image-wrapper">
                                        {{if itemsCount > 1}}
                                        <div class="rg-image-nav">
                                            <a href="#" class="rg-image-nav-prev">Previous Image</a>
                                            <a href="#" class="rg-image-nav-next">Next Image</a>
                                        </div>
                                        {{/if}}
                                        <div class="rg-image"></div>
                                        <div class="rg-loading"></div>
                                        @*<div class="rg-caption-wrapper">
                                                           <div class="rg-caption" style="display:none;">
                                                               <p></p>
                                                           </div>
                                            </div>*@
                                    </div>
                                </script>
                                <div id="rg-gallery" class="rg-gallery">
                                    <div class="rg-thumbs">
                                        <!-- Elastislide Carousel Thumbnail Viewer -->
                                        <div class="es-carousel-wrapper" id="main-carousel">
                                            <div class="es-nav">
                                                <span class="es-nav-prev">Previous</span>
                                                <span class="es-nav-next">Next</span>
                                            </div>
                                            <div class="es-carousel">
                                                <ul id="main-carousel-ul"></ul>
                                            </div>
                                        </div><!-- End Elastislide Carousel Thumbnail Viewer -->
                                    </div><!-- rg-thumbs -->
                                </div><!-- rg-gallery -->
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>
    @if (User.Identity.IsAuthenticated)
    {
        if (ViewBag.Rate.Count > 0)
        {
            <!-- Modal code -->
            <div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="reviewModalLabel">Đánh giá - @Html.DisplayFor(m => m.Name)</h4>
                        </div>
                        <div class="modal-body" style="padding-bottom:0px">
                            <script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.min.js")" type="text/javascript"></script>
                            <div class="row">
                                <div class="col-md-12">
                                    @using (Ajax.BeginForm("AddReview", "Review", null, new AjaxOptions { UpdateTargetId = "reviewList", OnSuccess = "reviewSuccess()" }, new { id = "ReviewForm", style = "margin-left:7.5px; margin-right:7.5px;", role = "form" }))
                                    {
                                        @Html.HiddenFor(model => model.Id)
                                        <div class="col-md-8">
                                            <input id="reviewTitle" name="title" class="form-control" placeholder="Nhập tiêu đề, ví dụ: Món ăn ở đây thật tuyệt " />
                                            <textarea id="reviewContent" name="content" class="form-control" style="min-height:180px;resize:none;margin-top:5px;" placeholder="Nhập nội dung bình luận"></textarea>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="block-heading-two" style="margin-top:-10px">
                                                <h3><span>Đánh giá</span></h3>
                                            </div>
                                            <div class="checkbox">
                                                <div style="line-height: 22px !important">
                                                    <label>
                                                        <input type="checkbox" id="chkRate" onchange="checkRateChange()" /> Đánh giá các chỉ tiêu
                                                    </label>
                                                </div>
                                            </div>
                                            <input type="hidden" name="checkRate" id="chkRateValue" value="false" />
                                            @{
                                        int i = 0;
                                        rateScript += "<script>$(function () {";
                                        string resetRateScript = "function resetReviewRate() {";
                                        string enableRateScript = "function enableRateScript() {";
                                        foreach (var rate in ViewBag.Rate)
                                        {
                                            var sliderId = "slider" + i;
                                            var valueId = "slider" + i + "value";
                                            <div class="row">
                                                <div style="height:10px;line-height:10px; margin: 10px 10px 0px 0px">
                                                    <div class="col-md-5">@Html.Raw(rate.RateCategory.Name)</div>
                                                    <div id="@sliderId" class="col-md-5"></div>
                                                    <div class="col-md-2"><p id="@valueId">5</p></div>
                                                </div>
                                            </div>
                                                <div class="row">
                                                    @{  var id = "rate_" + i + "_RateCategoryId";
                                                      var name = "rate[" + i + "].RateCategoryId";
                                                    }
                                                    <input id=@id name=@name type="hidden" value="@rate.RateCategoryId">
                                                    @{  id = "rate_" + i + "_Value";
                                                      name = "rate[" + i + "].Value";
                                                    }
                                                    <input id=@id name=@name type="hidden" value="5">
                                                </div>
                                                      rateScript += "$('#" + @sliderId + "').slider({ max: 10, min: 0, value: 5, disabled: true, change: function(event, ui) { updateRate('" + valueId + "','" + id + "',ui.value); } });";
                                                      resetRateScript += "$('#" + @sliderId + "').slider('value', 5);$('#" + @sliderId + "').slider( 'option', 'disabled', true );";
                                                      enableRateScript += "$('#" + @sliderId + "').slider('enable');";
                                                      i++;
                                        }
                                        resetRateScript += "}";
                                        enableRateScript += "}";
                                        rateScript += "});" + resetRateScript + enableRateScript + "</script>";
                                            }
                                        </div>
                                        <div id="images"></div>
                                    }
                                </div>
                                <div class="col-md-12">
                                    @using (Html.BeginForm("UploadReviewImage", "Review", FormMethod.Post, new { enctype = "multipart/form-data", @class = "form-horizontal dropzone", role = "form", @id = "ReviewUploadImageForm", style = "background:none;border:none" }))
                                    {
                                        <div class="form-group">
                                            <div id="previews" class="dropzone-previews">
                                                <h4 id="noImage"><i class="fa fa-camera"></i> Thêm hình ảnh</h4>
                                            </div>
                                        </div>
                                        <div>
                                            <button type="submit" id="btnReview" class="btn btn-color btn-sm" style="width:100%">Bình luận</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div>
        }
        else
        {
             <!-- Modal code -->
            <div class="modal fade" id="reviewModal" tabindex="-1" role="dialog" aria-labelledby="reviewModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                            <h4 class="modal-title" id="reviewModalLabel">Đánh giá - @Html.DisplayFor(m => m.Name)</h4>
                        </div>
                        <div class="modal-body" style="padding-bottom:0px">
                            <script src="@Url.Content("~/Scripts/jquery.unobtrusive-ajax.min.js")" type="text/javascript"></script>
                            <div class="row">
                                <div class="row">
                                    @using (Ajax.BeginForm("AddReview", "Place", null, new AjaxOptions { UpdateTargetId = "reviewList", OnSuccess = "reviewSuccess()" }, new { id = "ReviewForm", style = "margin-left:7.5px; margin-right:7.5px;", role = "form" }))
                                    {
                                        @Html.HiddenFor(model => model.Id)
                                        <div class="col-md-12">
                                            <input id="reviewTitle" name="title" class="form-control" placeholder="Nhập tiêu đề" />
                                            <textarea id="reviewContent" name="content" class="form-control" style="min-height:180px;resize:none;margin-top:5px;" placeholder="Nhập nội dung bình luận"></textarea>
                                        </div>
                                        <div id="images"></div>
                                    }
                                </div>
                                <div class="row">
                                    @using (Html.BeginForm("UploadReviewImage", "Place", FormMethod.Post, new { enctype = "multipart/form-data", @class = "form-horizontal dropzone", role = "form", @id = "ReviewUploadImageForm", style = "background:none;border:none" }))
                                    {
                                        <div class="form-group">
                                            <div id="previews" class="dropzone-previews">
                                                <h4 id="noImage"><i class="fa fa-camera"></i> Thêm hình ảnh</h4>
                                            </div>
                                        </div>
                                        <div>
                                            <button type="submit" id="btnReview" class="btn btn-color btn-sm" style="width:100%">Bình luận</button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div>
        }
    }
    @if (User.Identity.IsAuthenticated)
    {
    <!-- Modal code -->
        <div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="reportModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="reportModalLabel">Báo lỗi - @Html.DisplayFor(m => m.Name)</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            @using (Ajax.BeginForm("AddReport", "Place", null, new AjaxOptions { OnSuccess = "reportSuccess()", OnBegin = "return reportValid()" }))
                            {
                                @Html.HiddenFor(model => model.Id)
                                <div class="col-md-12">
                                    <textarea id="reportContent" name="reportContent" class="form-control" style="min-height:180px;resize:none;margin-top:5px;" placeholder="Nhập nội dung lỗi"></textarea>
                                </div>
                                <div class="col-md-12" style="margin-top:5px">
                                    <button type="submit" class="btn btn-color btn-sm" style="width:100%">Báo lỗi</button>
                                </div>
                            }
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>
    }
    <!-- Modal code -->
    <div class="modal fade" id="itemModal" tabindex="-1" role="dialog" aria-labelledby="itemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="itemModalLabel">Bảng giá - @Model.Name</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="table-responsive col-md-12" style="overflow-y:hidden;overflow-x:hidden;">
                            <table id="ItemTable" class="table table-striped table-bordered dataTable no-footer">
                                <thead>
                                    <tr>
                                        <th>
                                            Tên
                                        </th>
                                        <th>
                                            Giá
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Items)
                                    {
                                        <tr>
                                            <td>
                                                @item.Name
                                            </td>
                                            <td>
                                                <text>VND </text>@item.Price.ToString("N0")
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div>

    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC99lxB7ew2Zx9FaBA4xNW3nV6kaJX1ISs&sensor=false&language=ja&amp;libraries=places"></script>
    <script src="~/Scripts/jquery.geocomplete.js"></script>
    <script>
        var firstClick = true;
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();
        var map;
        var currentPosition;
        var marker;
        function initializeMap() {
            if(firstClick)
            {
                directionsDisplay = new google.maps.DirectionsRenderer();
                var myLatlng = new google.maps.LatLng(@Model.Coordinate.Latitude, @Model.Coordinate.Longitude);
                var mapOptions = {
                    zoom: 16,
                    center: myLatlng,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                }
                map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
                directionsDisplay.setMap(map);
                directionsDisplay.setPanel(document.getElementById('directions-panel'));
                marker = new google.maps.Marker({
                    position: myLatlng,
                    map: map,
                    icon: '@Url.Content(Model.SubCategory.Icon)'
                });
                google.maps.event.addListenerOnce(map, 'idle', function(){
                    google.maps.event.trigger(map, 'resize');
                    map.setCenter(myLatlng);
                });
                $("#startvalue").geocomplete({
                    country: 'vn'
                });
                firstClick = false;
            }
        }

        function calcRoute() {
            if(document.getElementById('startvalue').value.trim() == '')
            {
                document.getElementById('startvalue').value = '';
                document.getElementById('chkCurrLocation').checked = false;
                $.amaran({
                    content: {
                        bgcolor: '#ED5441',
                        color: '#fff',
                        message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Điểm xuất phát không xác định. Vui lòng kiểm tra lại</p>'
                    },
                    theme: 'colorful',
                    position: 'top right',
                });
            }
            else
            {
                clearMarkers();
                if(document.getElementById("chkCurrLocation").checked == true)
                    var start = currentPosition;
                else
                    var start = document.getElementById('startvalue').value;
                var request = {
                    origin:start,
                    destination: '@Html.Raw(Model.Coordinate.Latitude + "," + Model.Coordinate.Longitude)',
                    travelMode: google.maps.TravelMode.DRIVING
                };
                directionsService.route(request, function(response, status) {
                    if (status == google.maps.DirectionsStatus.OK) {
                        directionsDisplay.setDirections(response);
                    }
                });
                $("#route-panel").attr('style', 'display:block;');
                $('#collapseTwo-alt3').collapse('show');
            }
        }

        function getLocation() {
            if(document.getElementById("chkCurrLocation").checked == true)
            {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        var geocoder = new google.maps.Geocoder();
                        geocoder.geocode({
                            "location": new google.maps.LatLng(position.coords.latitude, position.coords.longitude)
                        },
                        function(results, status) {
                            if (status == google.maps.GeocoderStatus.OK)
                            {
                                document.getElementById("startvalue").value = results[0].formatted_address;
                                currentPosition = position.coords.latitude + "," + position.coords.longitude;
                            }
                            else
                            {
                                $.amaran({
                                    content: {
                                        bgcolor: '#ED5441',
                                        color: '#fff',
                                        message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Không thể lấy địa chỉ của bạn</p>'
                                    },
                                    theme: 'colorful',
                                    position: 'top right',
                                });
                            }
                        });
                    });
                } else {
                    $.amaran({
                        content: {
                            bgcolor: '#ED5441',
                            color: '#fff',
                            message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Trình duyệt của bạn không hỗ trợ</p>'
                        },
                        theme: 'colorful',
                        position: 'top right',
                    });
                }
            }
        }

        function clearMarkers() {
            marker.setMap(null);
        }

        $('#collapseOne-alt3').on('show.bs.collapse', function () {
            $('#collapseTwo-alt3').collapse('hide');
        });

        $('#collapseTwo-alt3').on('show.bs.collapse', function () {
            $('#collapseOne-alt3').collapse('hide');
        });

        function ChangeLocation() {
            if(document.getElementById("chkCurrLocation").checked == true)
                document.getElementById('chkCurrLocation').checked = false;
        }
    </script>
    <script src="~/Content/ResponsiveImageGallery/js/jquery.tmpl.min.js"></script>
    <script src="~/Content/ResponsiveImageGallery/js/jquery.easing.1.3.js"></script>
    <script src="~/Content/ResponsiveImageGallery/js/jquery.elastislide.js"></script>
    <script src="~/Content/ResponsiveImageGallery/js/gallery.js"></script>
    <div id='reviewList'>
        @{ Html.RenderPartial("~/Views/Review/PlaceReview.cshtml", Model.Reviews.Where(r => r.isActive == true)); }
    </div>
    <script>
        $('#imageModal').on('show.bs.modal', function (e) {
            $('.rg-image-wrapper').remove();
            Gallery.init();
        });
        $('#imageModal').on('shown.bs.modal', function (e) {
            Gallery.reset();
        });
        $('#place-carousel').elastislide({
            imageW 	: 65
        });
        $('[data-toggle="popover"]').popover({
            html : true
        });
        $(function () { showTotalReview(); });
        function showImage(imageId, placeId, reviewId)
        {
            $.ajax({
                url: '/Place/LoadImageList',
                type: 'POST',
                dataType: 'json',
                cache: false,
                async:   false,
                data: { imageId: imageId, placeId: placeId, reviewId : reviewId },
                success: function (data) {
                    if (data.success) {
                        $('#main-carousel-ul').empty();
                        var images = data.images;
                        for (var i = 0; i < images.length; i++)
                        {
                            var img = images[i];
                            $('#main-carousel-ul').append('<li><a href="#"><img src="' + img.ImageSmallPath + '" data-large="' + img.ImagePath + '" alt="image' + img.Id + '" data-description="@Model.Name" /></a></li>');
                        }
                        $('#imageModal').modal('show');
                    }
                    else
                    {
                        $.amaran({
                            content: {
                                bgcolor: '#ED5441',
                                color: '#fff',
                                message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Đã có lỗi xảy ra</p>'
                            },
                            theme: 'colorful',
                            position: 'top right',
                        });
                        location.reload();
                    }
                }
            });
        }
        function showTotalReview()
        {
            $.ajax({
                url: '/Review/TotalRate',
                type: 'POST',
                dataType: 'json',
                cache: false,
                async:   false,
                data: { Id : @Html.Raw(Model.Id) },
                success: function (data) {
                    if (data.isSuccess) {
                        var result = data.result;
                        $("#totalRateInfo").html("");
                        if(result.length > 0)
                        {
                            for (var i = 0; i < result.length; i++)
                            {
                                var rs = result[i];
                                if(!isNaN(rs.Value))
                                {
                                    $("#totalRateInfo").append("<div><span>" + (rs.Value/rs.Count).toFixed(1) + "</span><p>" + rs.Name + "</p></div>");
                                }
                                else
                                {
                                    $("#totalRateInfo").append("<div><span>" + rs.Value + "</span><p>" + rs.Name + "</p></div>");
                                }
                            }
                        }
                    }
                    else
                    {
                        $.amaran({
                            content: {
                                bgcolor: '#ED5441',
                                color: '#fff',
                                message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Đã có lỗi xảy ra</p>'
                            },
                            theme: 'colorful',
                            position: 'top right',
                        });
                        location.reload();
                    }
                }
            });
        }
        $(function () {
            oTable1 = $('#ItemTable').dataTable({
                "aoColumns": [
                  true, true
                ],
                "pagingType": "simple",
                "pageLength": 10,
                "paging": true,
                "bFilter": true,
                "bLengthChange": false,
                "bInfo": false
            });
        });
    </script>
    @if (User.Identity.IsAuthenticated)
    {
        <script src="~/Content/dropzone/dropzone.min.js"></script>
        <script src="~/Content/jquery-ui/jquery-ui-1.11.2/jquery-ui.min.js"></script>
        <script>
            $(function () {
                Dropzone.options.ReviewUploadImageForm = { // The camelized version of the ID of the form element

                    // The configuration we've talked about above
                    autoProcessQueue: false,
                    uploadMultiple: true,
                    parallelUploads: 5,
                    maxFiles: 5,
                    maxFilesize: 3,
                    addRemoveLinks: true,
                    acceptedFiles: "image/*",
                    dictRemoveFile: "Xóa ảnh",
                    dictInvalidFileType: "Tập tin không phải là hình ảnh",
                    dictFileTooBig: "Dung lượng ảnh lớn hơn 3MB",
                    dictMaxFilesExceeded: "Số lượng ảnh tối đa là 5",
                    previewsContainer: "#previews",
                    clickable: '#previews',
                    // The setting up of the dropzone
                    init: function () {
                        var myDropzone = this;
                        $('#reviewModal').on('hidden.bs.modal', function (e) {
                            $('#reviewTitle').val("");
                            $('#reviewContent').val("");
                            $('#btnReview').removeAttr('disabled');
                            $("#chkRate").prop('checked', false);
                            checkRateChange();
                            myDropzone.removeAllFiles();
                        });
                        // First change the button to actually tell Dropzone to process the queue.
                        this.element.querySelector("button[type=submit]").addEventListener("click", function (e) {
                            // Make sure that the form isn't actually being sent.
                            e.preventDefault();
                            e.stopPropagation();
                            var title = $('#reviewTitle').val();
                            if(title == null || $.trim(title).length <= 0)
                            {
                                $('#reviewTitle').val("");
                                $.amaran({
                                    content: {
                                        bgcolor: '#ED5441',
                                        color: '#fff',
                                        message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Vui lòng nhập tiêu đề</p>'
                                    },
                                    theme: 'colorful',
                                    position: 'top right',
                                });
                                $('#reviewTitle').focus();
                                return;
                            }
                            content = $('#reviewContent').val();
                            if(content == null || $.trim(content).length <= 0)
                            {
                                $('#reviewContent').val("");
                                $.amaran({
                                    content: {
                                        bgcolor: '#ED5441',
                                        color: '#fff',
                                        message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Vui lòng nhập nội dung bình luận</p>'
                                    },
                                    theme: 'colorful',
                                    position: 'top right',
                                });
                                $('#reviewContent').focus();
                                return;
                            }
                            if (myDropzone.getQueuedFiles().length == 0) {
                                $('#ReviewForm').submit();
                                return;
                            }
                            $(this).attr('disabled', 'disabled');
                            $(".dz-remove").attr('style', 'display:none;');
                            myDropzone.processQueue();
                        });
                        this.on("removedfile", function () {
                            if (this.getQueuedFiles().length == 0) {
                                $('#noImage').attr('style', 'display:block;');
                            }
                        });
                        this.on("addedfile", function () {
                            if (this.getQueuedFiles().length == 0) {
                                $('#noImage').attr('style', 'display:none;');
                            }
                        });
                        // Listen to the sendingmultiple event. In this case, it's the sendingmultiple event instead
                        // of the sending event because uploadMultiple is set to true.
                        this.on("sendingmultiple", function () {
                            // Gets triggered when the form is actually being sent.
                            // Hide the success button or the complete form.
                        });
                        this.on("successmultiple", function (files, response) {
                            // Gets triggered when the files have successfully been sent.
                            // Redirect user or notify of success.
                            if (response.isSuccess) {
                                var images = response.images;
                                for (var i = 0; i < images.length; i++)
                                {
                                    var img = images[i];
                                    $('#images').append("<input id='images_" + i + "_ImagePath' name='images[" + i + "].ImagePath' type='hidden' value='" + img.ImagePath + "'/>");
                                    $('#images').append("<input id='images_" + i + "_ImageSmallPath' name='images[" + i + "].ImageSmallPath' type='hidden' value='" + img.ImageSmallPath + "'/>");
                                }
                                $('#ReviewForm').submit();
                            }
                            else {
                                $.amaran({
                                    content: {
                                        bgcolor: '#ED5441',
                                        color: '#fff',
                                        message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Đã có lỗi xảy ra</p>'
                                    },
                                    theme: 'colorful',
                                    position: 'top right',
                                });
                                location.reload();
                            }
                        });
                        this.on("errormultiple", function (files, response) {
                            // Gets triggered when there was an error sending the files.
                            // Maybe show form again, and notify user of error
                        });
                    }
                }
            });

            function updateRate(valueId, id, value)
            {
                $("#" + valueId).html(value);
                $("#" + id).val(value);
            }

            function reviewSuccess()
            {
                $('#reviewModal').modal('hide');
                $('[data-toggle="popover"]').popover({
                    html : true
                });
                showTotalReview();
                resetPlaceCarousel(@Model.Id);
                $.amaran({
                    content: {
                        bgcolor: '#51D466',
                        color: '#fff',
                        message: '<strong>Xin cảm ơn!</strong><p style="font-size:12px">Đánh giá địa điểm thành công</p>'
                    },
                    theme: 'colorful',
                    position: 'top right',
                });
            }

            function removeReviewSuccess()
            {
                $('[data-toggle="popover"]').popover({
                    html : true
                });
                showTotalReview();
                resetPlaceCarousel(@Model.Id);
            }

            function checkRateChange()
            {
                if($("#chkRate").is(":checked"))
                {
                    $("#chkRateValue").val("true");
                    enableRateScript();
                }
                else
                {
                    $("#chkRateValue").val("false");
                    resetReviewRate();
                }
            }
            function resetPlaceCarousel(placeId)
            {
                $.ajax({
                    url: '/Place/LoadPlaceImageList',
                    type: 'POST',
                    dataType: 'json',
                    cache: false,
                    async:   false,
                    data: { placeId: placeId },
                    success: function (data) {
                        if (data.success) {
                            $('#place-carousel').elastislide('destroy');
                            $('#place-carousel').find('div.es-carousel').empty();
                            $('#place-carousel').find('div.es-carousel').append('<ul></ul>')
                            var images = data.images;
                            for (var i = 0; i < images.length; i++)
                            {
                                var img = images[i];
                                $('#place-carousel').find('ul').append('<li><a href="#"><img src="' + img.ImageSmallPath + '" alt="image' + img.Id + '" onclick="showImage(' + img.Id + ',' + @Model.Id + ',0)" /></a></li>');
                            }
                            $('#place-carousel').elastislide({
                                imageW 	: 65
                            });
                        }
                        else
                        {
                            $.amaran({
                                content: {
                                    bgcolor: '#ED5441',
                                    color: '#fff',
                                    message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Đã có lỗi xảy ra</p>'
                                },
                                theme: 'colorful',
                                position: 'top right',
                            });
                            location.reload();
                        }
                    }
                });
            }
            function reportValid()
            {
                content = $('#reportContent').val();
                if(content == null || $.trim(content).length <= 0)
                {
                    $('#reportContent').val("");
                    $.amaran({
                        content: {
                            bgcolor: '#ED5441',
                            color: '#fff',
                            message: '<strong>Xin lỗi!</strong><p style="font-size:12px">Vui lòng nhập nội dung lỗi</p>'
                        },
                        theme: 'colorful',
                        position: 'top right',
                    });
                    $('#reportContent').focus();
                    return false;
                }
                return true;
            }
            function reportSuccess()
            {
                $("#reportContent").val('');
                $("#reportModal").modal('hide');
                $.amaran({
                    content: {
                        bgcolor: '#51D466',
                        color: '#fff',
                        message: '<strong>Xin cảm ơn!</strong><p style="font-size:12px">Báo lỗi địa điểm thành công</p>'
                    },
                    theme: 'colorful',
                    position: 'top right',
                });
            }
        </script>
        @Html.Raw(rateScript)
    }
</div>
